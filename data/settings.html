<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>Réglages ESP32-S3</title>
<style>
body {
  /* AMÉLIORATION : Police système moderne */
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
  background:#111;
  color:#fff;
  display:flex;
  flex-direction:column;
  align-items:center;
  padding-top:3em;
}
.card {
  background:#1e1e1e;
  padding:2em;
  border-radius:1em;
  box-shadow:0 0 15px #000;
  width:300px;
  text-align:center;
}
input[type=range] { width:100%; cursor: pointer; }
button {
  background:#3b82f6;
  border:none;
  padding:.7em;
  color:white;
  border-radius:.5em;
  margin-top:1em;
  width:100%;
  cursor:pointer;
  font-size: 1em;
  font-weight: 600;
}
button:hover { background-color: #2563eb; }
</style>
</head>
<body>
<div class="card">
<h2>⚙️ Réglages</h2>
<label>Seuil d’alerte gaz :</label>
<input id="gasThreshold" type="range" min="10" max="100" value="60" oninput="valGas.value=this.value">
<p><output id="valGas">60</output> %</p>

<label style="margin-top: 1.5em; display: block;">Seuil d'alerte bruit :</label>
<input id="dbThreshold" type="range" min="40" max="100" value="65" oninput="valDb.value=this.value">
<p><output id="valDb">65</output> dB</p>

<!-- NOUVEAU : Réglage de la calibration dB -->
<label style="margin-top: 1.5em; display: block;">Correction Bruit (Calibration) :</label>
<input id="dbCorrection" type="range" min="-100" max="100" value="-50" oninput="valDbCorr.value=this.value">
<p><output id="valDbCorr">-50</output> dB</p>

<button onclick="apply()">Appliquer</button>
<button onclick="window.location.href='/index.html'">Retour</button>
</div>
<script>
async function apply(){
  const gasValue = document.getElementById('gasThreshold').value;
  const dbValue = document.getElementById('dbThreshold').value;
  const dbCorrValue = document.getElementById('dbCorrection').value; // Récupère la correction
  let success = true;

  try {
    // 1. Envoi du seuil de gaz
    let response = await fetch(`/settings?threshold=${gasValue}`);
    if (!response.ok) { success = false; alert("Erreur lors de l'enregistrement du seuil de gaz."); }

    // 2. Envoi du seuil de bruit
    response = await fetch(`/settings?dbThreshold=${dbValue}`);
    if (!response.ok) { success = false; alert("Erreur lors de l'enregistrement du seuil de bruit."); }

    // 3. NOUVEAU: Envoi de la correction de bruit
    response = await fetch(`/settings?dbCorrection=${dbCorrValue}`);
    if (!response.ok) { success = false; alert("Erreur lors de l'enregistrement de la correction de bruit."); }
    
    if (success) {
      alert("Réglages enregistrés ! Gaz: " + gasValue + "% / Bruit Seuil: " + dbValue + " dB / Correction: " + dbCorrValue + " dB.");
    }

  } catch (error) {
    alert("Erreur de connexion avec l'appareil.");
  }
}
</script>
</body>
</html>